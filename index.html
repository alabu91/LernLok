<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LernLok - Lokführer Training Schweiz</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --sbb-red: #d5001c;
            --sbb-dark: #2d3748;
            --bg-gray: #f4f7f6;
            --admin-bg: #1e293b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: var(--sbb-dark);
        }

        header {
            background: var(--sbb-red);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container { max-width: 600px; margin: 0 auto; padding: 1rem; }

        .view { display: none; }
        .view.active { display: block; }

        /* Dashboard */
        .topics-grid { display: grid; gap: 1rem; }
        .topic-card {
            background: white; border-radius: 12px; padding: 1.25rem;
            display: flex; align-items: center; gap: 1rem; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s;
            position: relative;
        }
        .topic-card:active { transform: scale(0.98); }
        .topic-icon-box {
            background: #fff5f5; color: var(--sbb-red);
            width: 48px; height: 48px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
        }
        .topic-locked {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #94a3b8;
            opacity: 0.7;
        }

        /* Quiz */
        .progress-container { height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden; margin: 10px 0; }
        #progress-bar { height: 100%; background: var(--sbb-red); width: 0%; transition: width 0.3s; }
        .question-card { background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .option-btn {
            width: 100%; padding: 1rem; margin-bottom: 0.75rem; border: 2px solid #edf2f7;
            border-radius: 12px; background: white; text-align: left; font-size: 1rem; cursor: pointer;
        }
        .option-btn.selected { border-color: var(--sbb-red); background: #fff5f5; }
        .action-btn { width: 100%; padding: 1rem; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 1rem; }
        .btn-primary { background: var(--sbb-red); color: white; }
        .btn-next { background: #2d3748; color: white; }
        .fb-box { padding: 1rem; border-radius: 10px; margin-top: 1rem; font-weight: 500; }
        .success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

        /* Admin Styles */
        .admin-panel { background: var(--admin-bg); color: white; padding: 1.5rem; border-radius: 16px; margin-top: 1rem; }
        .admin-form { display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 2rem; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 12px; }
        .admin-form input, .admin-form select, .admin-form textarea {
            padding: 10px; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: white; width: 100%;
        }
        .admin-list { max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .admin-item { padding: 12px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; background: #edf2f7; color: #475569; text-transform: uppercase; }
        .btn-admin-tab { background: none; border: none; color: #94a3b8; padding: 10px; cursor: pointer; font-weight: bold; }
        .btn-admin-tab.active { color: white; border-bottom: 2px solid var(--sbb-red); }
        
        #question-image { width: 100%; border-radius: 8px; margin-bottom: 1rem; max-height: 200px; object-fit: contain; background: #eee; }
        .admin-controls { display: flex; gap: 10px; }
        .btn-edit { color: #38bdf8; cursor: pointer; background: none; border: none; font-size: 0.8rem; }
        .btn-delete { color: #ef4444; cursor: pointer; background: none; border: none; font-size: 0.8rem; }

        /* Password Protection */
        .password-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .password-modal {
            background: white; padding: 2rem; border-radius: 16px;
            width: 90%; max-width: 400px; text-align: center;
        }
        .password-input {
            width: 100%; padding: 12px; margin: 1rem 0;
            border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;
        }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:10px; cursor:pointer" onclick="showDashboard()">
        <i data-lucide="train"></i>
        <h1 style="margin:0; font-size:1.2rem">LernLok PRO</h1>
    </div>
    <button onclick="toggleAdmin()" style="background:none; border:none; color:white; cursor:pointer">
        <i data-lucide="shield"></i>
    </button>
</header>

<div class="container">
    <div id="dashboard" class="view active">
        <h2 style="margin-bottom:1.5rem">Deine Lernmodule</h2>
        <div id="topics-grid" class="topics-grid"></div>
    </div>

    <div id="quiz-view" class="view">
        <div class="quiz-header">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span id="question-type-badge" class="badge">TYP</span>
                <span id="question-counter" style="font-size:0.9rem; color:#64748b">Frage 0/0</span>
            </div>
            <div class="progress-container"><div id="progress-bar"></div></div>
        </div>
        <div class="question-card">
            <div id="question-image-container" style="display:none"><img id="question-image" src="" alt="Bild"></div>
            <h3 id="question-text" style="margin-top:0; line-height:1.4">Lade...</h3>
            <div id="options-container"></div>
            <div id="feedback-area"></div>
            <button id="check-btn" class="action-btn btn-primary" onclick="checkCurrentAnswer()">Überprüfen</button>
            <button id="next-btn" class="action-btn btn-next" style="display:none" onclick="handleNext()">Weiter</button>
        </div>
    </div>

    <div id="result-view" class="view" style="text-align:center">
        <div class="question-card">
            <i data-lucide="award" style="width:64px; height:64px; color:#eab308; margin-bottom:1rem"></i>
            <h2 id="result-percentage" style="font-size:3rem; margin:0">0%</h2>
            <p id="result-text" style="color:#64748b; margin-bottom:2rem">Ergebnis</p>
            <button class="action-btn btn-primary" onclick="showDashboard()">Zurück zum Start</button>
        </div>
    </div>

    <div id="admin-view" class="view">
        <div class="admin-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem">
                <h2 id="admin-title">Admin Modus</h2>
                <button onclick="showDashboard()" style="background:none; border:1px solid #475569; color:white; padding:5px 10px; border-radius:5px">X</button>
            </div>

            <div class="admin-tabs" style="display:flex; gap:10px; margin-bottom:1rem">
                <button class="btn-admin-tab active" id="tab-questions" onclick="setAdminTab('questions')">Fragen</button>
                <button class="btn-admin-tab" id="tab-topics" onclick="setAdminTab('topics')">Themen</button>
            </div>

            <div id="admin-content-questions">
                <div class="admin-form" id="question-form">
                    <input type="hidden" id="adm-q-id">
                    <label style="font-size:0.8rem">Thema wählen</label>
                    <select id="adm-q-topic"></select>
                    
                    <label style="font-size:0.8rem">Fragentext</label>
                    <textarea id="adm-q-text" placeholder="Welches Signal zeigt..."></textarea>
                    
                    <label style="font-size:0.8rem">Optionen (mit Komma trennen)</label>
                    <input id="adm-q-options" placeholder="Halt, Fahrt, Vorsicht">
                    
                    <label style="font-size:0.8rem">Richtige Antwort (exakt wie oben oder bei Multi-Choice mit Komma)</label>
                    <input id="adm-q-correct" placeholder="Fahrt">
                    
                    <label style="font-size:0.8rem">Antwort-Typ</label>
                    <select id="adm-q-type">
                        <option value="single">Single Choice</option>
                        <option value="multi">Multi Choice</option>
                        <option value="fill">Texteingabe</option>
                    </select>
                    
                    <label style="font-size:0.8rem">Bild URL (optional)</label>
                    <input id="adm-q-image" placeholder="https://...">
                    
                    <div style="display:flex; gap:10px">
                        <button class="btn-primary" style="flex:2; padding:10px; border-radius:6px" onclick="saveQuestion()" id="btn-save-q">Frage speichern</button>
                        <button class="btn-next" style="flex:1; padding:10px; border-radius:6px; display:none" id="btn-cancel-q" onclick="resetQuestionForm()">Abbruch</button>
                    </div>
                </div>
                <div id="admin-questions-list" class="admin-list"></div>
            </div>

            <div id="admin-content-topics" style="display:none">
                <div class="admin-form">
                    <input id="adm-t-title" placeholder="Thema Titel (z.B. 300.2 Signale)">
                    <input id="adm-t-icon" placeholder="Icon Name (z.B. train, activity, book)">
                    <button class="btn-primary" style="padding:10px; border-radius:6px" onclick="saveTopic()">Thema speichern</button>
                </div>
                <div id="admin-topics-list" class="admin-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="password-overlay" class="password-overlay" style="display:none">
    <div class="password-modal">
        <i data-lucide="lock" style="width:48px; height:48px; color:var(--sbb-red); margin-bottom:1rem"></i>
        <h3 style="margin:0 0 0.5rem 0">Passwort erforderlich</h3>
        <p style="color:#64748b; margin-bottom:1rem">Bitte geben Sie das Admin-Passwort ein.</p>
        <input type="password" id="password-input" class="password-input" placeholder="Passwort eingeben">
        <div style="display:flex; gap:10px; margin-top:1rem">
            <button class="action-btn btn-next" style="flex:1" onclick="cancelPassword()">Abbrechen</button>
            <button class="action-btn btn-primary" style="flex:1" onclick="submitPassword()">Bestätigen</button>
        </div>
        <p id="password-error" style="color:#ef4444; font-size:0.9rem; margin-top:0.5rem; display:none">Falsches Passwort!</p>
    </div>
</div>

<script type="module">
    const SUPABASE_URL = 'https://nsidzovmagohzuwvikev.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zaWR6b3ZtYWdvaHp1d3Zpa2V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NTYwMjIsImV4cCI6MjA4NDAzMjAyMn0.U4pnm4pvFHif_dVAQnOANSynDEKMELjSoKFBm0KyNLw';

    let supabase;
    let topics = [];
    let questions = [];
    let currentTopic = null;
    let currentQuestionIndex = 0;
    let score = 0;
    let selectedAnswers = [];
    let currentShuffledOptions = [];
    let pendingTopicId = null;

    async function init() {
        if (window.lucide) window.lucide.createIcons();
        const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
        supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        await loadAll();
    }

    function naturalSort(a, b) {
        return a.title.localeCompare(b.title, undefined, { numeric: true, sensitivity: 'base' });
    }

    async function loadAll() {
        const { data: tData } = await supabase.from('topics').select('*');
        const { data: qData } = await supabase.from('questions').select('*');
        topics = (tData || []).sort(naturalSort);
        questions = qData || [];
        renderDashboard();
        renderAdmin();
    }

    window.switchView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if (window.lucide) window.lucide.createIcons();
    };

    window.showDashboard = () => switchView('dashboard');
    
    window.toggleAdmin = () => {
        const pw = prompt("Bitte Admin-Passwort eingeben:");
        if (pw === "admin123") switchView('admin-view');
        else if (pw !== null) alert("Falsches Passwort!");
    };

    function renderDashboard() {
        const grid = document.getElementById('topics-grid');
        grid.innerHTML = topics.map(t => {
            const count = questions.filter(q => q.topic_id === t.id).length;
            return `
                <div class="topic-card" onclick="checkTopicPassword('${t.id}')">
                    <div class="topic-icon-box"><i data-lucide="${t.icon || 'train'}"></i></div>
                    <div style="flex:1">
                        <h3 style="margin:0">${t.title}</h3>
                        <span style="font-size:0.8rem; color:#64748b">${count} Fragen</span>
                    </div>
                    <i data-lucide="lock" class="topic-locked" style="width:20px; height:20px"></i>
                    <i data-lucide="chevron-right" style="color:#cbd5e1"></i>
                </div>
            `;
        }).join('');
        if (window.lucide) window.lucide.createIcons();
    }

    window.checkTopicPassword = (id) => {
        pendingTopicId = id;
        document.getElementById('password-overlay').style.display = 'flex';
        document.getElementById('password-input').value = '';
        document.getElementById('password-error').style.display = 'none';
        document.getElementById('password-input').focus();
    };

    window.submitPassword = () => {
        const password = document.getElementById('password-input').value;
        if (password === "admin123") {
            document.getElementById('password-overlay').style.display = 'none';
            if (pendingTopicId) startQuizDirect(pendingTopicId);
        } else {
            document.getElementById('password-error').style.display = 'block';
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }
    };

    window.cancelPassword = () => {
        document.getElementById('password-overlay').style.display = 'none';
        pendingTopicId = null;
    };

    function startQuizDirect(id) {
        currentTopic = topics.find(t => t.id === id);
        const topicQuestions = questions.filter(q => q.topic_id === id);
        if (topicQuestions.length === 0) return alert("Dieses Thema hat noch keine Fragen.");
        currentTopic.qs = topicQuestions.sort(() => Math.random() - 0.5); 
        currentQuestionIndex = 0;
        score = 0;
        switchView('quiz-view');
        renderQuestion();
    }

    function renderQuestion() {
        const q = currentTopic.qs[currentQuestionIndex];
        selectedAnswers = [];
        document.getElementById('question-text').innerText = q.question_text;
        document.getElementById('question-counter').innerText = `Frage ${currentQuestionIndex+1}/${currentTopic.qs.length}`;
        document.getElementById('progress-bar').style.width = `${(currentQuestionIndex/currentTopic.qs.length)*100}%`;
        document.getElementById('question-type-badge').innerText = q.type;
        
        const imgCont = document.getElementById('question-image-container');
        if (q.image_url) {
            document.getElementById('question-image').src = q.image_url;
            imgCont.style.display = 'block';
        } else imgCont.style.display = 'none';

        const optCont = document.getElementById('options-container');
        optCont.innerHTML = '';
        if (q.type === 'fill') {
            optCont.innerHTML = `<input type="text" id="q-fill" class="option-btn" placeholder="Antwort...">`;
        } else {
            const raw = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
            currentShuffledOptions = [...raw].sort(() => Math.random() - 0.5);
            currentShuffledOptions.forEach((opt, idx) => {
                const b = document.createElement('button');
                b.className = 'option-btn';
                b.innerText = opt;
                b.onclick = () => {
                    if (q.type === 'single') {
                        document.querySelectorAll('.option-btn').forEach(x => x.classList.remove('selected'));
                        selectedAnswers = [idx];
                        b.classList.add('selected');
                    } else {
                        b.classList.toggle('selected');
                        if (selectedAnswers.includes(idx)) selectedAnswers = selectedAnswers.filter(v => v !== idx);
                        else selectedAnswers.push(idx);
                    }
                };
                optCont.appendChild(b);
            });
        }
        document.getElementById('check-btn').style.display = 'block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('feedback-area').innerHTML = '';
    }

    window.checkCurrentAnswer = () => {
        const q = currentTopic.qs[currentQuestionIndex];
        let correct = false;
        if (q.type === 'fill') {
            correct = document.getElementById('q-fill').value.trim().toLowerCase() === q.correct_answer.toLowerCase();
        } else {
            const user = selectedAnswers.map(i => currentShuffledOptions[i]).sort();
            // Erlaube jetzt sowohl | als auch Komma als Trenner für die Überprüfung
            const separators = /[|,]/;
            const valid = q.correct_answer.split(separators).map(s => s.trim()).sort();
            correct = JSON.stringify(user) === JSON.stringify(valid);
        }
        if (correct) score++;
        document.getElementById('feedback-area').innerHTML = `<div class="fb-box ${correct?'success':'error'}">${correct?'Richtig!':('Falsch. Richtig: '+q.correct_answer)}</div>`;
        document.getElementById('check-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'block';
    };

    window.handleNext = () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentTopic.qs.length) renderQuestion();
        else {
            switchView('result-view');
            const p = Math.round((score/currentTopic.qs.length)*100);
            document.getElementById('result-percentage').innerText = p + "%";
            document.getElementById('result-text').innerText = `${score} von ${currentTopic.qs.length} Fragen richtig.`;
        }
    };

    window.setAdminTab = (tab) => {
        document.querySelectorAll('.btn-admin-tab').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');
        document.getElementById('admin-content-questions').style.display = tab === 'questions' ? 'block' : 'none';
        document.getElementById('admin-content-topics').style.display = tab === 'topics' ? 'block' : 'none';
        resetQuestionForm();
    };

    function renderAdmin() {
        const qList = document.getElementById('admin-questions-list');
        qList.innerHTML = questions.map(q => {
            const topic = topics.find(t => t.id === q.topic_id)?.title || "Unbekannt";
            return `
                <div class="admin-item">
                    <div style="flex:1; min-width:0">
                        <div style="font-size:0.6rem; color:#94a3b8">${topic}</div>
                        <div style="font-size:0.8rem; overflow:hidden; white-space:nowrap; text-overflow:ellipsis">${q.question_text}</div>
                    </div>
                    <div class="admin-controls">
                        <button class="btn-edit" onclick="editQuestion('${q.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteItem('questions', '${q.id}')">Löschen</button>
                    </div>
                </div>
            `;
        }).join('');

        const tList = document.getElementById('admin-topics-list');
        tList.innerHTML = topics.map(t => `
            <div class="admin-item">
                <span>${t.title}</span>
                <button class="btn-delete" onclick="deleteItem('topics', '${t.id}')">Löschen</button>
            </div>
        `).join('');

        const tSelect = document.getElementById('adm-q-topic');
        tSelect.innerHTML = topics.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
    }

    window.editQuestion = (id) => {
        const q = questions.find(x => x.id === id);
        if (!q) return;
        document.getElementById('adm-q-id').value = q.id;
        document.getElementById('adm-q-topic').value = q.topic_id;
        document.getElementById('adm-q-text').value = q.question_text;
        const opts = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
        // Beim Editieren zeigen wir die Optionen mit Komma getrennt an
        document.getElementById('adm-q-options').value = opts.join(', ');
        document.getElementById('adm-q-correct').value = q.correct_answer;
        document.getElementById('adm-q-type').value = q.type;
        document.getElementById('adm-q-image').value = q.image_url || '';
        document.getElementById('btn-save-q').innerText = "Änderungen speichern";
        document.getElementById('btn-cancel-q').style.display = "inline-block";
        document.getElementById('admin-title').innerText = "Frage bearbeiten";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.resetQuestionForm = () => {
        document.getElementById('adm-q-id').value = "";
        document.getElementById('adm-q-text').value = "";
        document.getElementById('adm-q-options').value = "";
        document.getElementById('adm-q-correct').value = "";
        document.getElementById('adm-q-image').value = "";
        document.getElementById('btn-save-q').innerText = "Frage speichern";
        document.getElementById('btn-cancel-q').style.display = "none";
        document.getElementById('admin-title').innerText = "Admin Modus";
    };

    window.saveTopic = async () => {
        const title = document.getElementById('adm-t-title').value;
        const icon = document.getElementById('adm-t-icon').value;
        if (!title) return;
        await supabase.from('topics').insert([{ title, icon }]);
        await loadAll();
        document.getElementById('adm-t-title').value = "";
        document.getElementById('adm-t-icon').value = "";
    };

    window.saveQuestion = async () => {
        const id = document.getElementById('adm-q-id').value;
        const topic_id = document.getElementById('adm-q-topic').value;
        const question_text = document.getElementById('adm-q-text').value;
        const optionsStr = document.getElementById('adm-q-options').value;
        const correct_answer = document.getElementById('adm-q-correct').value;
        const type = document.getElementById('adm-q-type').value;
        const image_url = document.getElementById('adm-q-image').value;
        
        if (!question_text || !correct_answer) return alert("Text und Antwort sind Pflichtfelder");

        // Unterstützt jetzt Komma und Pipe als Trenner für die Eingabe
        const options = optionsStr.split(/[|,]/).map(s => s.trim()).filter(s => s !== "");
        const payload = { topic_id, question_text, options, correct_answer, type, image_url };

        if (id) await supabase.from('questions').update(payload).eq('id', id);
        else await supabase.from('questions').insert([payload]);
        
        resetQuestionForm();
        await loadAll();
    };

    window.deleteItem = async (table, id) => {
        if (!confirm("Wirklich löschen?")) return;
        await supabase.from(table).delete().eq('id', id);
        await loadAll();
    };

    document.getElementById('password-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitPassword();
    });

    init();
</script>
</body>
</html>
